---
import Layout from '../../layouts/Layout.astro';
import ProductCard from '../../components/shop/ProductCard.astro';
import { fetchTags, fetchTagBySlug } from '../../lib/api';
import { ArrowLeft } from 'lucide-react';

export async function getStaticPaths() {
  const tags = await fetchTags();
  return tags.map((t) => ({
    params: { tag: t.slug },
    props: { tag: t },
  }));
}

export const prerender = true;

const { tag: tagSlug } = Astro.params;
const { tag, products } = await fetchTagBySlug(tagSlug);

const mappedProducts = products.map((p) => ({
  id: p.id,
  slug: p.slug,
  name: p.name,
  price: Number(p.base_price),
  description: p.description,
  image_filename: p.image_filename,
  category: tag.name,
}));

const noindex = mappedProducts.length < 3;
---

<Layout title={`Camisetas de ${tag.name}`} description={tag.description || `Camisetas de ${tag.name} para desarrolladores`} noindex={noindex}>

  <div class="mb-8">
    <a href="/" class="inline-flex items-center gap-2 text-text-muted hover:text-primary transition-colors font-medium">
      <ArrowLeft className="w-4 h-4" />
      Volver a la tienda
    </a>
  </div>

  <div class="mb-8">
    <h1 class="text-3xl font-bold text-text-main">Camisetas de {tag.name}</h1>
    {tag.description && (
      <p class="text-text-muted mt-2">{tag.description}</p>
    )}
    <p class="text-sm text-text-muted mt-1">{mappedProducts.length} producto(s)</p>
  </div>

  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
    {mappedProducts.map((product, i) => (
      <ProductCard product={product} priority={i < 4} />
    ))}
  </div>

  {mappedProducts.length === 0 && (
    <div class="text-center py-24 text-text-muted">
      <p>No hay productos con este tag aun.</p>
    </div>
  )}
</Layout>
