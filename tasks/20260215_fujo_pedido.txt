Perfecto, eso es exactamente el factory pattern que planteamos antes. Con eso claro, aquí está el plan completo:

---

# Plan — Flujo de Pedido

## Principio de diseño
El flujo de pedido nunca sabe qué pasarela está activa. Solo habla con una interfaz común. Cambiar de Wompi a cualquier otra pasarela implica crear un archivo nuevo y cambiar una variable de entorno. Nada más.

---

## Variables de entorno

Agregar a `.env.example`:

```env
PAYMENT_PROVIDER=wompi
WOMPI_PUBLIC_KEY=
WOMPI_PRIVATE_KEY=
WOMPI_EVENTS_SECRET=
SHIPPING_COST=15000
FREE_SHIPPING_THRESHOLD=150000
FRONTEND_URL=http://localhost:4321
```

---

## Modelo de datos

### Modificaciones a la tabla `orders` existente

```sql
ALTER TABLE orders
ADD COLUMN email VARCHAR(255),
ADD COLUMN city VARCHAR(100),
ADD COLUMN department VARCHAR(100),
ADD COLUMN shipping_cost DECIMAL(12,0) DEFAULT 0,
ADD COLUMN payment_session_id VARCHAR(255),
ADD COLUMN magic_token VARCHAR(255) UNIQUE,
ADD COLUMN magic_token_expires_at TIMESTAMP WITH TIME ZONE;
```

### Tabla nueva `order_status_history`

Registra cada cambio de estado de la orden para trazabilidad completa:

```sql
CREATE TABLE order_status_history (
    id SERIAL PRIMARY KEY,
    order_id INTEGER REFERENCES orders(id),
    status VARCHAR(50) NOT NULL,
    note TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);
```

---

## Arquitectura del módulo de pagos

### Estructura de carpetas

```
server/src/
└── payments/
    ├── payment.interface.js    ← contrato común
    ├── wompi.adapter.js        ← implementación Wompi
    └── payment.factory.js      ← elige adaptador según .env
```

### Contrato `payment.interface.js`

Define los tres métodos que cualquier adaptador debe implementar:

- `createSession(order)` — recibe la orden completa, devuelve lo que el frontend necesita para iniciar el pago. Para Wompi devuelve los parámetros del widget. Para otra pasarela devolvería su equivalente.
- `verifyWebhook(payload, signature)` — verifica que la notificación viene realmente de la pasarela y no es un request malicioso. Devuelve booleano.
- `parseWebhookEvent(payload)` — extrae del payload de la pasarela los datos normalizados: `{ orderId, status, paymentSessionId }`. Siempre el mismo formato sin importar la pasarela.

### `payment.factory.js`

Lee `PAYMENT_PROVIDER` del env y retorna el adaptador correspondiente. Si el provider no existe lanza un error al iniciar el servidor, no en runtime.

---

## Capas del backend

### Repositorios

**`order.repository.js`** — funciones:

- `create(orderData)` — inserta en `orders` y en `order_items` dentro de una transacción. Retorna la orden completa.
- `findByPublicId(publicId)` — para la página de consulta del cliente
- `findByMagicToken(token)` — para el link mágico del email
- `findByPhoneAndPublicId(phone, publicId)` — búsqueda manual como fallback
- `updateStatus(orderId, status)` — cambia el estado y registra en `order_status_history`
- `updatePaymentSession(orderId, paymentSessionId)` — guarda el ID de sesión de la pasarela
- `findById(orderId)` — para el admin

**`stock.repository.js`** — archivo nuevo separado, una sola función:

- `decrementStock(variantId, quantity)` — `UPDATE variants SET stock = stock - $2 WHERE id = $1 AND stock >= $2 RETURNING id`. Si retorna 0 filas significa que no había stock suficiente en ese momento.

### Services

**`order.service.js`**:

- `calculateShipping(subtotal)` — lee `SHIPPING_COST` y `FREE_SHIPPING_THRESHOLD` del env, retorna el costo de envío
- `generatePublicId()` — genera `ORD-XXXX` con número random de 4 dígitos, verifica que no exista en BD
- `generateMagicToken()` — genera un token único con `crypto.randomBytes`, establece expiración de 30 días
- `createOrder(customerData, cartItems)` — orquesta todo: valida stock, calcula total, calcula envío, genera IDs, crea la orden en BD, llama al payment factory para crear la sesión, retorna la respuesta al frontend
- `confirmPayment(webhookPayload, signature)` — verifica el webhook, actualiza el estado a `PAID`, llama a `decrementStock` por cada item en una transacción
- `getOrderByToken(token)` — valida que el token no haya expirado, retorna la orden con sus items
- `getOrderByPhoneAndId(phone, publicId)` — para búsqueda manual

**`email.service.js`** — archivo nuevo:

- `sendOrderConfirmation(order, magicToken)` — arma el email con el número de pedido, link mágico y resumen. Usa Resend como proveedor. Si falla, registra el error con el logger pero no lanza excepción para no interrumpir el flujo del pedido. El pedido existe aunque el email falle.

### Controllers

**`order.controller.js`**:

- `createOrder` — valida con Zod, llama al service, retorna `{ publicId, paymentData }`
- `getOrderByToken` — para el link mágico
- `getOrderBySearch` — para búsqueda por número y teléfono
- `handleWebhook` — para las notificaciones de la pasarela

### Validación Zod del body de crear orden

```
customer_name: string min 2
customer_email: email válido
customer_phone: string min 10
customer_address: string min 5
city: string min 2
department: string min 2
items: array min 1 de { variant_id: number, quantity: number min 1 }
```

### Rutas

En `public.routes.js` agregar:

```
POST /api/orders                          → createOrder
GET  /api/orders/token/:token             → getOrderByToken
GET  /api/orders/:publicId/:phone         → getOrderBySearch
```

En `webhooks.routes.js` agregar:

```
POST /api/webhooks/payment                → handleWebhook
```

El endpoint de webhook usa el nombre genérico `/payment` en lugar de `/wompi` para que no cambie si se cambia la pasarela.

---

## Frontend

### Flujo de pantallas

```
ProductCard → CartFlyout → /checkout → /pedido/confirmacion?id=ORD-1234
                                     ↓
                               Widget de pago
                                     ↓
                          Wompi redirige a /pedido/confirmacion
```

### `/checkout` — página nueva

Componente React con `client:only` por ser interactivo. Tres secciones visibles simultáneamente en desktop, en pasos en mobile:

**Sección 1 — Resumen del carrito**
Solo lectura. Productos, cantidades, subtotal. Calculado desde Nano Stores.

**Sección 2 — Datos del cliente**
Formulario con los campos definidos en la validación Zod. Validación en cliente antes de enviar.

**Sección 3 — Envío y total**
Muestra el costo de envío calculado en el servidor. Se actualiza cuando el usuario completa los datos y hace submit. Nunca calculado en el frontend.

**Al hacer submit:**
- Llama a `POST /api/orders` con los datos del formulario y el carrito
- El backend retorna `{ publicId, paymentData }`
- El frontend inicializa el widget de pago con `paymentData`
- Wompi maneja el resto y redirige a la URL de confirmación

### `/pedido/confirmacion` — página nueva

Recibe `?id=ORD-1234` como query param. Muestra:

- Número de pedido en grande
- Mensaje: *"Guarda este número para consultar tu pedido"*
- Resumen del pedido
- Estado actual
- Botón para compartir por WhatsApp

Vacía el carrito de Nano Stores al cargar.

### `/pedido` — página nueva

Formulario de búsqueda manual con dos campos: número de pedido y teléfono. Al buscar llama a `GET /api/orders/:publicId/:phone`. Muestra el detalle del pedido si existe.

### `/pedido/tracking` — página nueva

Recibe el token del link mágico como query param. Llama a `GET /api/orders/token/:token`. Si el token expiró muestra mensaje y redirige a `/pedido` para búsqueda manual.

### `api.js` — funciones nuevas

- `createOrder(customerData, cartItems)`
- `getOrderByToken(token)`
- `searchOrder(publicId, phone)`

---

## Secuencia completa del flujo

```
1. Cliente hace submit en /checkout
2. Frontend llama POST /api/orders
3. Backend valida stock de cada variante
4. Backend calcula subtotal + envío
5. Backend crea orden en PENDING_PAYMENT (transacción)
6. Backend genera magic token
7. Backend llama a payment.factory → wompi.adapter.createSession()
8. Backend retorna { publicId, paymentData } al frontend
9. Frontend inicializa widget Wompi con paymentData
10. Cliente completa el pago en el widget
11. Wompi llama POST /api/webhooks/payment
12. Backend verifica firma del webhook
13. Backend llama a payment.factory → wompi.adapter.parseWebhookEvent()
14. Si pago exitoso:
    → Actualiza orden a PAID
    → Decrementa stock en transacción
    → Llama a email.service.sendOrderConfirmation()
    → Registra en order_status_history
15. Wompi redirige cliente a /pedido/confirmacion?id=ORD-1234
```

---

## Consideraciones críticas para el agente

**El stock se descuenta en el webhook, no al crear la orden.** Esto evita bloquear stock de pagos que nunca se completan.

**El webhook debe verificar la firma siempre.** Sin esta verificación cualquiera puede llamar al endpoint y marcar órdenes como pagadas.

**El email nunca interrumpe el flujo.** Si `sendOrderConfirmation` falla, se registra en el logger y el flujo continúa normalmente.

**`generatePublicId` debe verificar unicidad en BD.** En caso de colisión regenera hasta encontrar uno disponible, máximo 3 intentos.

**Las transacciones son obligatorias** en dos puntos: crear orden + items, y decrementar stock de todos los items del pedido.

---

## Resumen de archivos

| Archivo | Acción |
|---|---|
| `init.sql` | Migración con ALTER TABLE y nueva tabla |
| `payments/payment.interface.js` | Nuevo |
| `payments/wompi.adapter.js` | Nuevo |
| `payments/payment.factory.js` | Nuevo |
| `repositories/order.repository.js` | Nuevo |
| `repositories/stock.repository.js` | Nuevo |
| `services/order.service.js` | Nuevo |
| `services/email.service.js` | Nuevo |
| `controllers/order.controller.js` | Nuevo |
| `public.routes.js` | Agregar rutas de órdenes |
| `webhooks.routes.js` | Agregar ruta de webhook |
| `client/src/pages/checkout.astro` | Nuevo |
| `client/src/pages/pedido/confirmacion.astro` | Nuevo |
| `client/src/pages/pedido/index.astro` | Nuevo |
| `client/src/pages/pedido/tracking.astro` | Nuevo |
| `client/src/lib/api.js` | Agregar funciones de órdenes |










Claude pendiente!!






 Plan — Flujo de Pedido                                                    

 Contexto

 El proyecto GeekShop necesita un flujo de checkout completo: desde que el cliente hace click en "Finalizar Compra" hasta la confirmación del pago y el seguimiento del pedido. Se usa Wompi como pasarela de pagos con un patrón Factory para permitir
 cambiar de proveedor fácilmente. El backend es Express + PostgreSQL, el frontend Astro (static) + React islands.

 ---
 Fase 1: Base de datos y configuración

 1.1 Migración server/database/migrations/004_orders_update.sql

 - ALTER TABLE orders: agregar email, city, department, shipping_cost, payment_session_id, magic_token, magic_token_expires_at
 - CREATE TABLE order_status_history (id, order_id, status, note, created_at)
 - Crear índices para magic_token y order_status_history.order_id

 1.2 Modificar server/src/config/env.js

 Agregar: paymentProvider, wompiPublicKey, wompiPrivateKey, wompiEventsSecret, shippingCost, freeShippingThreshold, resendApiKey, emailFrom, frontendUrl

 1.3 Actualizar server/src/.env.example

 Agregar las variables correspondientes

 ---
 Fase 2: Módulo de pagos (Factory Pattern)

 2.1 Crear server/src/payments/payment.interface.js

 - Función validateAdapter(adapter) que verifica que tenga createSession, verifyWebhook, parseWebhookEvent

 2.2 Crear server/src/payments/wompi.adapter.js

 - createSession(order) → devuelve datos para el widget Wompi (publicKey, amountInCents, reference, redirectUrl, signature integrity)
 - verifyWebhook(payload, signature) → HMAC-SHA256 con crypto.timingSafeEqual
 - parseWebhookEvent(payload) → normaliza a { reference, status, paymentSessionId }

 2.3 Crear server/src/payments/payment.factory.js

 - Lee env.paymentProvider, retorna el adaptador correspondiente. Cachea el resultado.

 ---
 Fase 3: Repositorios

 3.1 Crear server/src/repositories/stock.repository.js

 - decrementStock(variantId, quantity, client) → UPDATE variants SET stock = stock - $2 WHERE id = $1 AND stock >= $2 RETURNING id, stock

 3.2 Crear server/src/repositories/order.repository.js

 Siguiendo el patrón de product.repository.js (import pool, export async functions, transacciones con pool.connect()):
 - create(orderData) → transacción: INSERT orders + INSERT order_items + INSERT order_status_history
 - findByPublicId(publicId) → JOIN con order_items, variants, products
 - findByMagicToken(token) → con verificación de expiración
 - findByPhoneAndPublicId(phone, publicId)
 - updateStatus(orderId, status, note) → UPDATE orders + INSERT order_status_history
 - updatePaymentSession(orderId, paymentSessionId)
 - findById(orderId)
 - findItemsByOrderId(orderId)

 ---
 Fase 4: Servicios

 4.1 Crear server/src/services/order.service.js

 Siguiendo el patrón de product.service.js:
 - calculateShipping(subtotal) → lee de env
 - generatePublicId() → ORD-XXXX, verifica unicidad, max 3 intentos
 - generateMagicToken() → crypto.randomBytes(32), expira en 30 días
 - createOrder(customerData, cartItems) → validar stock (lectura), calcular subtotal/envío, crear orden, crear sesión de pago, retornar { publicId, paymentData }
 - confirmPayment(webhookPayload, signature) → verificar webhook, actualizar estado, decrementar stock en transacción, enviar email (fire-and-forget)
 - getOrderByToken(token) → wrapper con error ORDER_NOT_FOUND
 - getOrderByPhoneAndId(phone, publicId) → wrapper con error ORDER_NOT_FOUND

 4.2 Crear server/src/services/email.service.js

 - Instalar resend npm package
 - sendOrderConfirmation(order, magicToken) → nunca lanza excepción, solo logea errores
 - Si RESEND_API_KEY no está configurada, skip silencioso

 ---
 Fase 5: Controller y rutas

 5.1 Crear server/src/controllers/order.controller.js

 Siguiendo el patrón de admin.product.controller.js (Zod + try/catch + error codes):
 - Schema Zod: customer_name, customer_email, customer_phone, customer_address, city, department, items[]
 - createOrder(req, res) → 201
 - getOrderByToken(req, res) → por params.token
 - getOrderBySearch(req, res) → por params.publicId + params.phone
 - handleWebhook(req, res) → leer signature del header, siempre responder 200 a webhooks

 5.2 Modificar server/src/routes/public.routes.js

 Agregar: POST /orders, GET /orders/token/:token, GET /orders/:publicId/:phone

 5.3 Modificar server/src/routes/webhooks.routes.js

 Agregar: POST /payment → handleWebhook

 5.4 Modificar server/src/app.js

 - Importar webhookRoutes
 - Registrar /api/webhooks con express.json({ verify }) para raw body ANTES del express.json() general
 - Montar app.use('/api/webhooks', ...) antes de las demás rutas

 ---
 Fase 6: Frontend — Store y API

 6.1 Modificar client/src/lib/cartStore.js

 - Agregar clearCart = () => cartItems.set([])

 6.2 Modificar client/src/lib/api.js

 Agregar funciones siguiendo el patrón existente (fetch + error check):
 - createOrder(orderData) → POST /api/orders
 - getOrderByToken(token) → GET /api/orders/token/:token
 - searchOrder(publicId, phone) → GET /api/orders/:publicId/:phone

 6.3 Modificar client/src/components/shop/CartFlyout.jsx

 - Cambiar el <button> de "Finalizar Compra" por un <a href="/checkout"> con onClick={closeCart}

 ---
 Fase 7: Frontend — Páginas

 Todas las páginas de checkout usan client:only="react" (el sitio es static output, los datos se cargan client-side).

 7.1 Crear client/src/pages/checkout.astro + client/src/components/shop/CheckoutForm.jsx

 - Formulario: nombre, email, teléfono, dirección, ciudad, departamento (dropdown con los 32 departamentos de Colombia)
 - Resumen del carrito (readonly, desde nanostores)
 - Al submit: POST /api/orders → recibe paymentData → inicializa widget Wompi
 - El cart item .id ES el variant_id (confirmado en código)

 7.2 Crear client/src/pages/pedido/confirmacion.astro + client/src/components/shop/OrderConfirmation.jsx

 - Lee ?id=ORD-XXXX de window.location.search
 - Llama clearCart() al montar
 - Muestra número de pedido, mensaje de guardar, botón WhatsApp

 7.3 Crear client/src/pages/pedido/index.astro + client/src/components/shop/OrderSearch.jsx

 - Formulario: número de pedido + teléfono → GET /api/orders/:publicId/:phone
 - Muestra detalle del pedido si existe

 7.4 Crear client/src/pages/pedido/tracking.astro + client/src/components/shop/OrderTracking.jsx

 - Lee ?token=... de window.location.search
 - GET /api/orders/token/:token
 - Si expirado, redirige a /pedido

 ---
 Resumen de archivos (24 archivos)

 ┌─────┬──────────────────────────────────────────────────┬───────────┐
 │  #  │                     Archivo                      │  Acción   │
 ├─────┼──────────────────────────────────────────────────┼───────────┤
 │ 1   │ server/database/migrations/004_orders_update.sql │ Crear     │
 ├─────┼──────────────────────────────────────────────────┼───────────┤
 │ 2   │ server/src/config/env.js                         │ Modificar │
 ├─────┼──────────────────────────────────────────────────┼───────────┤
 │ 3   │ server/src/.env.example                          │ Modificar │
 ├─────┼──────────────────────────────────────────────────┼───────────┤
 │ 4   │ server/src/payments/payment.interface.js         │ Crear     │
 ├─────┼──────────────────────────────────────────────────┼───────────┤
 │ 5   │ server/src/payments/wompi.adapter.js             │ Crear     │
 ├─────┼──────────────────────────────────────────────────┼───────────┤
 │ 6   │ server/src/payments/payment.factory.js           │ Crear     │
 ├─────┼──────────────────────────────────────────────────┼───────────┤
 │ 7   │ server/src/repositories/stock.repository.js      │ Crear     │
 ├─────┼──────────────────────────────────────────────────┼───────────┤
 │ 8   │ server/src/repositories/order.repository.js      │ Crear     │
 ├─────┼──────────────────────────────────────────────────┼───────────┤
 │ 9   │ server/src/services/email.service.js             │ Crear     │
 ├─────┼──────────────────────────────────────────────────┼───────────┤
 │ 10  │ server/src/services/order.service.js             │ Crear     │
 ├─────┼──────────────────────────────────────────────────┼───────────┤
 │ 11  │ server/src/controllers/order.controller.js       │ Crear     │
 ├─────┼──────────────────────────────────────────────────┼───────────┤
 │ 12  │ server/src/routes/public.routes.js               │ Modificar │
 ├─────┼──────────────────────────────────────────────────┼───────────┤
 │ 13  │ server/src/routes/webhooks.routes.js             │ Modificar │
 ├─────┼──────────────────────────────────────────────────┼───────────┤
 │ 14  │ server/src/app.js                                │ Modificar │
 ├─────┼──────────────────────────────────────────────────┼───────────┤
 │ 15  │ client/src/lib/cartStore.js                      │ Modificar │
 ├─────┼──────────────────────────────────────────────────┼───────────┤
 │ 16  │ client/src/lib/api.js                            │ Modificar │
 ├─────┼──────────────────────────────────────────────────┼───────────┤
 │ 17  │ client/src/components/shop/CartFlyout.jsx        │ Modificar │
 ├─────┼──────────────────────────────────────────────────┼───────────┤
 │ 18  │ client/src/pages/checkout.astro                  │ Crear     │
 ├─────┼──────────────────────────────────────────────────┼───────────┤
 │ 19  │ client/src/components/shop/CheckoutForm.jsx      │ Crear     │
 ├─────┼──────────────────────────────────────────────────┼───────────┤
 │ 20  │ client/src/pages/pedido/confirmacion.astro       │ Crear     │
 ├─────┼──────────────────────────────────────────────────┼───────────┤
 │ 21  │ client/src/components/shop/OrderConfirmation.jsx │ Crear     │
 ├─────┼──────────────────────────────────────────────────┼───────────┤
 │ 22  │ client/src/pages/pedido/index.astro              │ Crear     │
 ├─────┼──────────────────────────────────────────────────┼───────────┤
 │ 23  │ client/src/components/shop/OrderSearch.jsx       │ Crear     │
 ├─────┼──────────────────────────────────────────────────┼───────────┤
 │ 24  │ client/src/pages/pedido/tracking.astro           │ Crear     │
 └─────┴──────────────────────────────────────────────────┴───────────┘

 Dependencia npm a instalar

 - resend en server/

 Verificación

 1. Ejecutar migración SQL en la BD
 2. npm install resend en server/
 3. Arrancar el servidor y verificar que las rutas responden
 4. Verificar que el frontend compila sin errores (npm run build en client/)
 5. Flujo manual: agregar productos al carrito → checkout → crear orden → verificar en BD
╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌

 Claude has written up a plan and is ready to execute. Would you like to proceed?

 ❯ 1. Yes, clear context and auto-accept edits (shift+tab)
   2. Yes, auto-accept edits
   3. Yes, manually approve edits
   4. Type here to tell Claude what to change





● All modules parse and import correctly.                         
                                           
● All 24 files have been implemented. Here's a summary of what was done:                                                                                                                                                                                      
                                                
  Backend (server/)                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                              
  ┌───────────────────────────────────────────┬─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐                                                                                 
  │                   File                    │                                                           Action                                                            │                                                                                 
  ├───────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
  │ database/migrations/004_orders_update.sql │ Created — adds email, city, department, shipping_cost, payment_session_id, magic_token columns + order_status_history table │                                                                                 
  ├───────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤                                                                                 
  │ src/config/env.js                         │ Modified — added payment, shipping, email, and frontend URL config                                                          │                                                                                 
  ├───────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤                                                                                 
  │ src/.env.example                          │ Created — all env variables documented                                                                                      │                                                                                 
  ├───────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
  │ src/payments/payment.interface.js         │ Created — validates adapter methods                                                                                         │                                                                                 
  ├───────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤                                                                                 
  │ src/payments/wompi.adapter.js             │ Created — createSession, verifyWebhook (HMAC-SHA256 + timingSafeEqual), parseWebhookEvent                                   │                                                                                 
  ├───────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤                                                                                 
  │ src/payments/payment.factory.js           │ Created — reads provider from env, caches adapter                                                                           │                                                                                 
  ├───────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤                                                                                 
  │ src/repositories/stock.repository.js      │ Created — decrementStock with atomic check                                                                                  │                                                                                 
  ├───────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤                                                                                 
  │ src/repositories/order.repository.js      │ Created — full CRUD with transactions                                                                                       │                                                                                 
  ├───────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤                                                                                 
  │ src/services/email.service.js             │ Created — Resend integration, silent fail                                                                                   │
  ├───────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
  │ src/services/order.service.js             │ Created — createOrder, confirmPayment, shipping calc, magic tokens                                                          │
  ├───────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
  │ src/controllers/order.controller.js       │ Created — Zod validation, 4 endpoints                                                                                       │
  ├───────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
  │ src/routes/public.routes.js               │ Modified — added POST /orders, GET /orders/token/:token, GET /orders/:publicId/:phone                                       │
  ├───────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
  │ src/routes/webhooks.routes.js             │ Created — POST /payment                                                                                                     │
  ├───────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
  │ src/app.js                                │ Modified — mounted webhook routes before general JSON parser                                                                │
  └───────────────────────────────────────────┴─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘

  Frontend (client/)

  ┌───────────────────────────────────────────┬──────────────────────────────────────────────────────────────┐
  │                   File                    │                            Action                            │
  ├───────────────────────────────────────────┼──────────────────────────────────────────────────────────────┤
  │ src/lib/cartStore.js                      │ Modified — added clearCart()                                 │
  ├───────────────────────────────────────────┼──────────────────────────────────────────────────────────────┤
  │ src/lib/api.js                            │ Modified — added createOrder, getOrderByToken, searchOrder   │
  ├───────────────────────────────────────────┼──────────────────────────────────────────────────────────────┤
  │ src/components/shop/CartFlyout.jsx        │ Modified — button → <a href="/checkout">                     │
  ├───────────────────────────────────────────┼──────────────────────────────────────────────────────────────┤
  │ src/pages/checkout.astro                  │ Created                                                      │
  ├───────────────────────────────────────────┼──────────────────────────────────────────────────────────────┤
  │ src/components/shop/CheckoutForm.jsx      │ Created — form with 32 departments, Wompi widget integration │
  ├───────────────────────────────────────────┼──────────────────────────────────────────────────────────────┤
  │ src/pages/pedido/confirmacion.astro       │ Created                                                      │
  ├───────────────────────────────────────────┼──────────────────────────────────────────────────────────────┤
  │ src/components/shop/OrderConfirmation.jsx │ Created — clears cart, shows order ID, WhatsApp button       │
  ├───────────────────────────────────────────┼──────────────────────────────────────────────────────────────┤
  │ src/pages/pedido/index.astro              │ Created                                                      │
  ├───────────────────────────────────────────┼──────────────────────────────────────────────────────────────┤
  │ src/components/shop/OrderSearch.jsx       │ Created — search by publicId + phone                         │
  ├───────────────────────────────────────────┼──────────────────────────────────────────────────────────────┤
  │ src/pages/pedido/tracking.astro           │ Created                                                      │
  ├───────────────────────────────────────────┼──────────────────────────────────────────────────────────────┤
  │ src/components/shop/OrderTracking.jsx     │ Created — magic token tracking with progress steps           │
  └───────────────────────────────────────────┴──────────────────────────────────────────────────────────────┘

  Dependency

  - resend installed in server/

  Next steps

  1. Run the migration 004_orders_update.sql against your database
  2. Set WOMPI_PUBLIC_KEY, WOMPI_PRIVATE_KEY, WOMPI_EVENTS_SECRET in your .env
  3. Start the server and test the full flow


