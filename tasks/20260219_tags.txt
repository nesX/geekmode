# Instrucciones para el Agente — Sistema de Tags

## Contexto
Sistema de tags plano (sin jerarquía) para clasificación granular de productos. Los tags se almacenan en el `search_vector` existente para búsqueda automática y tienen URLs dedicadas `/tags/[tag]` para SEO. El admin puede crear tags desde un pool predefinido y agregar nuevos sobre la marcha (híbrido).

---

## Migración SQL

Crear archivo `server/database/migrations/010_add_tags.sql`:

```sql
-- Tabla de tags
CREATE TABLE IF NOT EXISTS tags (
  id SERIAL PRIMARY KEY,
  name VARCHAR(50) UNIQUE NOT NULL,
  slug VARCHAR(50) UNIQUE NOT NULL,
  description TEXT,
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- Tabla intermedia producto-tags (muchos a muchos)
CREATE TABLE IF NOT EXISTS product_tags (
  product_id INTEGER REFERENCES products(id) ON DELETE CASCADE,
  tag_id INTEGER REFERENCES tags(id) ON DELETE CASCADE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (product_id, tag_id)
);

-- Índices
CREATE INDEX IF NOT EXISTS idx_tags_slug ON tags(slug);
CREATE INDEX IF NOT EXISTS idx_tags_active ON tags(is_active);
CREATE INDEX IF NOT EXISTS idx_product_tags_tag_id ON product_tags(tag_id);
CREATE INDEX IF NOT EXISTS idx_product_tags_product_id ON product_tags(product_id);

-- Trigger para updated_at de tags
CREATE TRIGGER update_tags_modtime 
BEFORE UPDATE ON tags 
FOR EACH ROW EXECUTE PROCEDURE update_updated_at_column();

-- Actualizar función de search_vector para incluir tags
CREATE OR REPLACE FUNCTION update_product_search_vector()
RETURNS TRIGGER AS $$
DECLARE
  category_names TEXT;
  tag_names TEXT;
BEGIN
  -- Obtener nombres de categorías
  SELECT string_agg(c.name, ' ')
  INTO category_names
  FROM categories c
  JOIN product_categories pc ON pc.category_id = c.id
  WHERE pc.product_id = NEW.id;
  
  -- Obtener nombres de tags
  SELECT string_agg(t.name, ' ')
  INTO tag_names
  FROM tags t
  JOIN product_tags pt ON pt.tag_id = t.id
  WHERE pt.product_id = NEW.id;
  
  -- Combinar todo en el search_vector
  NEW.search_vector := 
    setweight(to_tsvector('spanish', COALESCE(NEW.name, '')), 'A') ||
    setweight(to_tsvector('spanish', COALESCE(NEW.description, '')), 'B') ||
    setweight(to_tsvector('spanish', COALESCE(NEW.search_keywords, '')), 'A') ||
    setweight(to_tsvector('spanish', COALESCE(category_names, '')), 'B') ||
    setweight(to_tsvector('spanish', COALESCE(tag_names, '')), 'B');

  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Trigger que actualiza search_vector cuando cambian los tags
CREATE OR REPLACE FUNCTION update_product_search_on_tag_change()
RETURNS TRIGGER AS $$
BEGIN
  IF TG_OP = 'DELETE' THEN
    UPDATE products SET updated_at = NOW() WHERE id = OLD.product_id;
    RETURN OLD;
  ELSE
    UPDATE products SET updated_at = NOW() WHERE id = NEW.product_id;
    RETURN NEW;
  END IF;
END;
$$ LANGUAGE plpgsql;

DROP TRIGGER IF EXISTS trigger_update_search_on_tag ON product_tags;
CREATE TRIGGER trigger_update_search_on_tag
  AFTER INSERT OR DELETE ON product_tags
  FOR EACH ROW
  EXECUTE FUNCTION update_product_search_on_tag_change();

-- Tags iniciales comunes para tienda geek
INSERT INTO tags (name, slug, description) VALUES
('Backend', 'backend', 'Desarrollo backend y servidores'),
('Frontend', 'frontend', 'Desarrollo frontend y UI'),
('Full Stack', 'full-stack', 'Desarrollo fullstack'),
('DevOps', 'devops', 'DevOps e infraestructura'),
('Cloud', 'cloud', 'Computación en la nube'),
('Docker', 'docker', 'Contenedores y Docker'),
('Kubernetes', 'kubernetes', 'Orquestación de contenedores'),
('Git', 'git', 'Control de versiones'),
('Database', 'database', 'Bases de datos'),
('API', 'api', 'APIs y servicios web'),
('Mobile', 'mobile', 'Desarrollo móvil'),
('Desktop', 'desktop', 'Aplicaciones de escritorio'),
('Linux', 'linux', 'Sistema operativo Linux'),
('Open Source', 'open-source', 'Software libre'),
('Principiante', 'principiante', 'Para desarrolladores principiantes'),
('Avanzado', 'avanzado', 'Para desarrolladores avanzados'),
('Humor', 'humor', 'Diseños con humor geek'),
('Minimalista', 'minimalista', 'Diseños minimalistas'),
('Retro', 'retro', 'Diseños retro o vintage'),
('Colorido', 'colorido', 'Diseños con muchos colores')
ON CONFLICT DO NOTHING;

-- Actualizar search_vector de productos existentes
UPDATE products SET updated_at = NOW();

COMMENT ON TABLE tags IS 'Tags para clasificación granular de productos';
COMMENT ON TABLE product_tags IS 'Relación muchos a muchos entre productos y tags';
```

El usuario ejecutará esta migración manualmente.

---

## Backend

### `repositories/tag.repository.js`

Archivo nuevo con las siguientes funciones:

**`findAll()`** — Retorna todos los tags activos ordenados alfabéticamente por nombre

**`findAllWithCount()`** — Retorna tags activos con el conteo de productos que tiene cada uno:
```sql
SELECT t.*, COUNT(pt.product_id) as product_count
FROM tags t
LEFT JOIN product_tags pt ON pt.tag_id = t.id
WHERE t.is_active = true
GROUP BY t.id
ORDER BY t.name
```

**`findBySlug(slug)`** — Retorna un tag por su slug o `null` si no existe

**`findById(id)`** — Retorna un tag por id

**`findByProductId(productId)`** — Retorna todos los tags de un producto específico

**`create({ name, slug, description })`** — Inserta un tag nuevo. El slug debe ser único.

**`update(id, { name, description })`** — Actualiza nombre y descripción. El slug nunca se modifica después de creado.

**`delete(id)`** — Soft delete, marca `is_active = false`. Solo permitir si el tag no tiene productos asociados.

**`findProductsByTag(tagId, limit)`** — Productos activos que tienen un tag específico:
```sql
SELECT p.*, COALESCE(SUM(v.stock), 0) as total_stock,
       pi.filename as image_filename
FROM products p
JOIN product_tags pt ON pt.product_id = p.id
LEFT JOIN variants v ON v.product_id = p.id
LEFT JOIN product_images pi ON pi.product_id = p.id AND pi.is_primary = true
WHERE pt.tag_id = $1 AND p.is_active = true
GROUP BY p.id, pi.filename
ORDER BY p.created_at DESC
LIMIT $2
```

### `repositories/product.repository.js`

Agregar dos funciones para gestionar la relación:

**`setTags(productId, tagIds)`** — Reemplaza todos los tags de un producto en una transacción:
```sql
BEGIN;
DELETE FROM product_tags WHERE product_id = $1;
-- Insertar nuevos tags
INSERT INTO product_tags (product_id, tag_id) 
VALUES ($1, $2), ($1, $3), ... ;
COMMIT;
```

**`findTagsByProductId(productId)`** — Wrapper de `tag.repository.findByProductId` para mantener consistencia

### `services/tag.service.js`

Archivo nuevo:

**`getAllTags()`** — Llama a `findAll()` del repositorio

**`getTagsWithCount()`** — Llama a `findAllWithCount()` para el admin

**`getTagBySlug(slug)`** — Valida que exista y esté activo, lanza `TAG_NOT_FOUND` si no

**`createTag({ name, description })`** — Genera el slug automáticamente desde el nombre usando slugify (lowercase, reemplazar espacios con guiones, quitar caracteres especiales). Valida que el slug no exista. Si existe lanza `TAG_ALREADY_EXISTS`.

**`updateTag(id, data)`** — Actualiza solo nombre y descripción, nunca el slug

**`deleteTag(id)`** — Valida que no tenga productos asociados antes de desactivar. Si tiene productos lanza `TAG_HAS_PRODUCTS` con el conteo.

**`getProductsByTag(slug, limit = 50)`** — Obtiene el tag por slug y luego sus productos

**Helper interno `slugify(text)`:**
```javascript
function slugify(text) {
  return text
    .toString()
    .toLowerCase()
    .trim()
    .replace(/\s+/g, '-')     // espacios a guiones
    .replace(/[^\w\-]+/g, '') // quitar caracteres especiales
    .replace(/\-\-+/g, '-')   // guiones múltiples a uno solo
}
```

### `services/product.service.js`

Agregar función:

**`updateProductTags(productId, tagIds)`** — Llama a `setTags` del repositorio. Los `tagIds` deben validarse que existan antes de actualizar.

### `controllers/tag.controller.js`

Archivo nuevo con handlers públicos:

**`getTags`** — Retorna todos los tags activos para el selector del admin y para la tienda

**`getTagBySlug`** — Retorna un tag con sus productos asociados. Endpoint para la página `/tags/[tag]`

### `controllers/admin.tag.controller.js`

Archivo nuevo con handlers protegidos:

**`getAllTags`** — Retorna tags con conteo de productos para la vista de gestión

**`createTag`** — Valida con Zod, llama al service

**`updateTag`** — Valida con Zod, llama al service

**`deleteTag`** — Llama al service, responde con error claro si tiene productos

### `controllers/admin.product.controller.js`

Agregar handler:

**`updateTags`** — Recibe array de `tagIds`, llama a `updateProductTags` del service

### Validación Zod

En `admin.tag.controller.js`:

```javascript
const TagSchema = z.object({
  name: z.string().min(2).max(50),
  description: z.string().max(500).optional()
})

const UpdateTagsSchema = z.object({
  tagIds: z.array(z.number().int().positive()).max(10)
})
```

### Rutas

En `public.routes.js` agregar:

```
GET /api/tags
GET /api/tags/:slug/products
```

En `admin.routes.js` agregar:

```
GET    /api/admin/tags
POST   /api/admin/tags
PUT    /api/admin/tags/:id
DELETE /api/admin/tags/:id
PATCH  /api/admin/products/:id/tags
```

---

## Frontend — Tienda

### Página `/tags/[tag]`

Crear `client/src/pages/tags/[tag].astro`.

**getStaticPaths():**
```javascript
export async function getStaticPaths() {
  const response = await fetch(`${API_URL}/api/tags`)
  const { tags } = await response.json()
  
  return tags.map(tag => ({
    params: { tag: tag.slug },
    props: { tag }
  }))
}

export const prerender = true
```

**Contenido de la página:**

Estructura idéntica a la página de categorías:
- Título: "Camisetas de {tag.name}"
- Descripción del tag si existe
- Grid de productos usando `ProductCard.astro`
- Todas las imágenes con `loading="lazy"` y `priority={false}`

Hacer fetch a `GET /api/tags/:slug/products` en el frontmatter para obtener los productos.

**SEO:** Si el tag tiene menos de 3 productos, agregar `<meta name="robots" content="noindex, follow">` para evitar thin content.

### Modificar página de detalle de producto

En `client/src/pages/producto/[slug].astro` mostrar los tags del producto como badges clicables debajo del precio y antes de la descripción.

Cada tag es un link a `/tags/{tag.slug}` con estilo de pill/badge usando Tailwind:
- `bg-gray-200 text-gray-800 px-3 py-1 rounded-full text-sm`
- Hover: `hover:bg-gray-300`

Los tags se obtienen cuando se hace fetch del producto, incluirlos en la query de `findBySlug` del producto agregando un JOIN a `product_tags` y `tags`.

### Modificar `Footer.astro`

Agregar una sección "Tags Populares" con los 10 tags más usados. Hacer fetch a `GET /api/tags` en el frontmatter, ordenar por `product_count DESC`, tomar los primeros 10, mostrarlos como links.

---

## Frontend — Admin

### Vista de gestión de tags

Crear `client/src/components/admin/TagsView.jsx`.

**Estructura:**

Tabla con columnas: Nombre, Slug, Productos (contador), Acciones

**Acciones por fila:**
- Botón Editar → abre `TagModal`
- Botón Eliminar → solo habilitado si `product_count === 0`

Botón "Nuevo Tag" arriba de la tabla que abre `TagModal` en modo creación.

### Modal de tags

Crear `client/src/components/admin/TagModal.jsx`.

Formulario con:
- Nombre (input text, requerido)
- Descripción (textarea, opcional)
- En modo edición mostrar el slug como campo de solo lectura

El slug se genera automáticamente en el backend, no enviarlo desde el frontend en creación.

Al guardar llamar a `POST /api/admin/tags` o `PUT /api/admin/tags/:id`.

### Selector de tags en productos

Modificar `client/src/components/admin/ProductModal.jsx` para agregar un selector de tags debajo de las categorías.

**Implementación:**

Multi-select con checkboxes mostrando todos los tags disponibles. Los tags ya asignados al producto vienen pre-seleccionados.

Límite visual de 10 tags seleccionados. Deshabilitar checkboxes adicionales cuando se alcance el límite.

Botón "Crear tag nuevo" que abre un mini-modal inline para crear un tag sobre la marcha sin cerrar el modal del producto.

Al guardar el producto, enviar el array de `tagIds` seleccionados a `PATCH /api/admin/products/:id/tags`.

### Agregar al `AdminDashboard.jsx`

Agregar "Tags" a la navegación del dashboard. Al seleccionarla renderiza `TagsView.jsx`.

---

## Modificaciones a queries existentes

### En `product.repository.js`

Modificar `findBySlug()` para incluir los tags del producto en el resultado:

```sql
SELECT p.*,
       json_agg(DISTINCT jsonb_build_object(
         'id', t.id, 'name', t.name, 'slug', t.slug
       )) FILTER (WHERE t.id IS NOT NULL) as tags,
       -- resto de campos...
FROM products p
LEFT JOIN product_tags pt ON pt.product_id = p.id
LEFT JOIN tags t ON t.id = pt.tag_id AND t.is_active = true
WHERE p.slug = $1
GROUP BY p.id
```

---

## Consideraciones críticas para el agente

**El slug de un tag nunca se modifica después de creado** para no romper URLs indexadas. Solo nombre y descripción son editables.

**La función `slugify` debe ser robusta** para manejar caracteres especiales, espacios múltiples, y acentos. Convertir "Full Stack" → "full-stack", "DevOps" → "devops".

**Los triggers actualizan el search_vector automáticamente** cuando se agregan o quitan tags de un producto. No escribir lógica manual para esto.

**Validar unicidad del slug en el backend** antes de crear. Si "backend" ya existe y alguien intenta crear "Backend", debe fallar.

**El límite de 10 tags por producto es validación solo en el frontend** para UX. El backend debe validar también con el schema Zod.

**Las páginas de tags con menos de 3 productos deben tener noindex** para evitar penalizaciones de SEO por thin content.

**Al eliminar un tag, verificar primero que no tenga productos asociados.** Si tiene, responder con error 400 indicando cuántos productos lo usan.

**Los tags iniciales en la migración son sugerencias.** El admin puede crear más según necesidad real del catálogo.

---

## Resumen de archivos

| Archivo | Acción |
|---|---|
| `server/database/migrations/010_add_tags.sql` | Crear migración |
| `repositories/tag.repository.js` | Nuevo |
| `repositories/product.repository.js` | Agregar `setTags` y modificar `findBySlug` |
| `services/tag.service.js` | Nuevo |
| `services/product.service.js` | Agregar `updateProductTags` |
| `controllers/tag.controller.js` | Nuevo |
| `controllers/admin.tag.controller.js` | Nuevo |
| `controllers/admin.product.controller.js` | Agregar handler `updateTags` |
| `public.routes.js` | Agregar 2 rutas |
| `admin.routes.js` | Agregar 5 rutas |
| `client/src/pages/tags/[tag].astro` | Nuevo |
| `client/src/pages/producto/[slug].astro` | Modificar para mostrar tags |
| `client/src/components/ui/Footer.astro` | Agregar sección tags populares |
| `client/src/components/admin/TagsView.jsx` | Nuevo |
| `client/src/components/admin/TagModal.jsx` | Nuevo |
| `client/src/components/admin/ProductModal.jsx` | Agregar selector de tags |
| `client/src/components/admin/AdminDashboard.jsx` | Agregar vista Tags |




 Sistema de Tags — Implementado

  Migración SQL

  - 011_add_tags.sql — Tablas tags y product_tags, índices, trigger updated_at, función update_product_search_vector() actualizada para incluir tags en el search_vector, trigger para actualizar search_vector al cambiar tags, y 20 tags iniciales.

  Nota: La migración debe ejecutarse manualmente: psql -d tu_db -f server/database/migrations/011_add_tags.sql

  Backend (nuevos)

  ┌─────────────────────────────────────┬──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
  │               Archivo               │                                                               Descripción                                                                │
  ├─────────────────────────────────────┼──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
  │ repositories/tag.repository.js      │ findAll, findAllWithCount, findBySlug, findById, findByProductId, create, update, deactivate, countProducts, findProductsByTag           │
  ├─────────────────────────────────────┼──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
  │ services/tag.service.js             │ getAllTags, getTagsWithCount, getTagBySlug, createTag (con slugify), updateTag, deleteTag (valida productos asociados), getProductsByTag │
  ├─────────────────────────────────────┼──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
  │ controllers/tag.controller.js       │ getTags, getTagBySlug (público, retorna tags con product_count)                                                                          │
  ├─────────────────────────────────────┼──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
  │ controllers/admin.tag.controller.js │ getAllTags, createTag, updateTag, deleteTag con validación Zod                                                                           │
  └─────────────────────────────────────┴──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘

  Backend (modificados)

  ┌─────────────────────────────────────────┬─────────────────────────────────────────────────────────────────────────┐
  │                 Archivo                 │                                 Cambio                                  │
  ├─────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────┤
  │ repositories/product.repository.js      │ findBySlug incluye tags; nuevas funciones setTags y findTagsByProductId │
  ├─────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────┤
  │ services/product.service.js             │ Nueva función updateProductTags                                         │
  ├─────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────┤
  │ controllers/admin.product.controller.js │ Nuevo handler updateTags                                                │
  ├─────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────┤
  │ routes/public.routes.js                 │ GET /api/tags, GET /api/tags/:slug/products                             │
  ├─────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────┤
  │ routes/admin.routes.js                  │ GET/POST/PUT/DELETE /api/admin/tags, PATCH /api/admin/products/:id/tags │
  └─────────────────────────────────────────┴─────────────────────────────────────────────────────────────────────────┘

  Frontend (nuevos)

  ┌───────────────────────────────┬─────────────────────────────────────────────────────────────────────────────┐
  │            Archivo            │                                 Descripción                                 │
  ├───────────────────────────────┼─────────────────────────────────────────────────────────────────────────────┤
  │ pages/tags/[tag].astro        │ Página estática /tags/[tag] con grid de productos; noindex si < 3 productos │
  ├───────────────────────────────┼─────────────────────────────────────────────────────────────────────────────┤
  │ components/admin/TagsView.jsx │ Tabla admin con Nombre, Slug, Productos, Acciones                           │
  ├───────────────────────────────┼─────────────────────────────────────────────────────────────────────────────┤
  │ components/admin/TagModal.jsx │ Modal crear/editar tag; slug de solo lectura en edición                     │
  └───────────────────────────────┴─────────────────────────────────────────────────────────────────────────────┘

  Frontend (modificados)

  ┌─────────────────────────────────────┬───────────────────────────────────────────────────────────────────────┐
  │               Archivo               │                                Cambio                                 │
  ├─────────────────────────────────────┼───────────────────────────────────────────────────────────────────────┤
  │ lib/api.js                          │ fetchTags(), fetchTagBySlug()                                         │
  ├─────────────────────────────────────┼───────────────────────────────────────────────────────────────────────┤
  │ layouts/Layout.astro                │ Prop noindex para <meta name="robots">                                │
  ├─────────────────────────────────────┼───────────────────────────────────────────────────────────────────────┤
  │ pages/producto/[slug].astro         │ Badges de tags clicables debajo del precio                            │
  ├─────────────────────────────────────┼───────────────────────────────────────────────────────────────────────┤
  │ components/ui/Footer.astro          │ Sección "Tags Populares" con los 10 más usados                        │
  ├─────────────────────────────────────┼───────────────────────────────────────────────────────────────────────┤
  │ components/admin/ProductModal.jsx   │ Selector multi-tag con límite de 10, carga tags existentes en edición │
  ├─────────────────────────────────────┼───────────────────────────────────────────────────────────────────────┤
  │ components/admin/AdminDashboard.jsx │ Vista "Tags" en navegación sidebar                                    │
  └─────────────────────────────────────┴───────────────────────────────────────────────────────────────────────┘
